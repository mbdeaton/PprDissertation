\chapter{Technical Introduction}
\label{chap:intro}

\input{conventions}

\section{General Relativistic Hydrodynamics}
\label{sec:gr_hydro}
Here we introduce the equations describing the transport of particle number,
momentum, and energy by massive particles in the continuum limit, that is
a fluid.

Fluid dynamics are described in curved spacetime by the general relativistic
hydrodynamics equations:
\begin{align}
  \label{eqn:hydro_mass}
  \nabla_\alpha \rho u^\alpha &= 0 \\
  \label{eqn:hydro_mom}
  \nabla_\alpha T^{\alpha\beta} &= 0,
\end{align}
where $\nabla_\alpha$ is the covariant derivative,
$\rho$ the rest mass density,
$u^\alpha$ the four-velocity,
and $T^{\alpha\beta}$ the stress-energy tensor:
\begin{equation}
  \label{eqn:stress_energy}
  T^{\alpha\beta} = \rho h u^\alpha u^\beta + P \psi^{\alpha\beta},
\end{equation}
Here we have used $h=1+\epsilon+P/\rho c^2$ the specific enthalpy,
$\epsilon$ the specific energy,
$P$ the pressure, and
$\psi^{\alpha\beta}$ the inverse of the spacetime metric.
Eqns.~\ref{eqn:hydro_mass} and~\ref{eqn:hydro_mom} elegantly express the
conservation of mass and energy-momentum respectively.
Additionally, fluid composition changes by the charged-current interactions
(Eqns.~\ref{eqn:beta_n_to_p} and~\ref{eqn:beta_p_to_n} and their inverse processes),
and the corresponding lepton number conservation is expressed as an additional
conservation equation (Eqn.~\ref{eqn:conservation_equations}).
We reserve discussion of the composition equation for Sec.~\ref{sec:leakage}

Using the foliation of spacetime presented in Sec.~\ref{ssec:adm_metric}, we may
write these equations in conservative hyperbolic form,
using coordinate derivatives:
\begin{align}
  \label{eqn:adm_hydro_mass}
  \partial_t \rho_* + \partial_j \rho_* v^j &= 0 \\
  \label{eqn:adm_hydro_mom}
  \partial_t \tilde{S}_i + \partial_j(\alpha\sqrt{g}T^j_i) &=
  \frac{1}{2}\alpha\sqrt{g}T^{\mu\gamma}\partial_i\psi_{\mu\gamma} \\
  \label{eqn:adm_hydro_ener}
  \partial_t \tilde{\tau} + \partial_j(\alpha^2\sqrt{g}T^{0j}-\rho_*v^j) &=
  -\alpha\sqrt{g}T^{\mu\gamma}\nabla_\mu n_\gamma,
\end{align}
which express conservation of mass, momentum, and energy on the spatial slice.
In this form, we have introduced the conservative variables
\begin{align}
  \label{eqn:rhostar}
  \rho_*       &\equiv -\sqrt{g} n_\mu u^\mu \rho &&= \sqrt{g}W\rho \\
  \label{eqn:tildeS}
  \tilde{S_i}  &\equiv -\sqrt{g} n_\mu T^\mu_i    &&= \rho_* h u_i \\
  \label{eqn:tildetau}
  \tilde{\tau} &\equiv  \sqrt{g} n_\mu n_\gamma T^{\mu\gamma} - \rho_*
  &&= \rho_*(u^t h-1)-\sqrt{g}P,
\end{align}
where $W=\alpha u^t$ is the general relativistic Lorentz factor.

These are the hydrodynamic equations we solve to determine the evolution of
our model. The numerical algorithm we employ to solve them is described
in \citet[App.~A]{fouc2013-compactness_and_spin}.
The equations and algorithm used to compute the
evolution of the spacetime metric is described in
\citet{lind2007-gen_harmonic}.

\section{General Relativistic Radiation Transport}
\label{sec:rad_transport}
Here we introduce the equations describing the transport of particle number,
momentum, and energy by massless particles in the continuum limit, that is,
by a field.

We begin with the familiar equations in flat spacetime, and then extend this
to a covariant formulation appropriate to situations with strong gravity.
We follow closely the treatment by \citet{miha1999-foundations}.

\subsection{Flat Spacetime}
The basic quantity of radiation is the specific intensity,
\begin{equation}
  \mathcal{I}(t,x^j;\nu,\Omega_k) \qquad \qquad
  {\rm erg}\,{\rm str}^{-1}\,{\rm cm}^{-2}\,{\rm Hz}^{-1}\,{\rm s}^{-1}, \nonumber
\end{equation}
where $\{t,x^j\}$ is the time and position of interest,
$\nu=c/\lambda$ the frequency\footnote{not the neutrino symbol as elsewhere},
related to the energy by Planck's constant $\varepsilon=h\nu$, and
$\Omega_k$ a normalized direction vector. Though a three-vector, $\Omega_k$
has only two degrees of freedom, which may be made explicit by parameterizing
in two angles; for example in cartesian components
$\Omega_k:=(\sin\alpha\cos\beta,\sin\alpha\sin\beta,\cos\alpha)$.

$\mathcal{I}$ is a time-dependent scalar field on a six-dimensional manifold,
$\{x^j,p_k\}$, with $p_k\equiv\frac{h\nu}{c}\Omega_k$.
We may visualize this space as an infinite bundle of rays---actually the
cotangent bundle $T^*M$ to the three-dimensional
spatial manifold $M^3:\{x^j\}$---and $\mathcal{I}$
assigns a weight to each ray, telling us how much of the radiation field has
momentum $p_k$ at point $x^j$. A ray is an element of $T^*M$,
and a beam is a subset of $T^*M$.

How much energy is in a beam?
The energy transported by a beam at $x^j$,
in a direction $\Omega_k$,
spread across a solid angle $\diff\Omega=\cos\alpha\,\diff\alpha\,\diff\beta$,
passing through a surface $\diff a$
oriented by normalized direction vector $a^i$,
within a frequency band $\diff \nu$ centered on $\nu$,
over a time $\diff t$ centered on $t$ is
\begin{align}
  \label{eqn:beam_energy_I_nu}
  \diff E &= \mathcal{I}(t,x^j;\nu,\Omega_k)\,
  \mu\, \diff\Omega\, \diff a\, \diff\nu\, \diff t \\
  \label{eqn:beam_energy_I_eps}
  &= \frac{1}{h} \mathcal{I}(t,x^j;p_k)\,
  \mu\, \diff\Omega\, \diff a\, \diff\varepsilon\, \diff t,
\end{align}
where $\mu\equiv a^i\Omega_i$ is the cosine of the angle between $a^i$ and
$\Omega^i$, and in Euclidean space $\Omega_i=\Omega^i$.

\subsubsection{The Particle Picture}
Much of what follows borrows from the particle picture of the radiation field.
By quantizing our cotangent bundle $T^*M$ into states (in other words,
quantum phase space), we may arrive at a particle formulation that is completely
analogous to the continuum picture.

The basic quantity of radiation in the particle picture is the distribution
function, $f(t,x^j;p_k)$, the number of particles per state in phase space.
Since each neutrino quantum state has a volume $h^{-3}$, where $h$ is Planck's
constant\footnote{the volume would be $2h^{-3}$ for photons, which exhibit two
distinct helicities},
the number of particles per phase space volume $\diff^3x\,\diff^3p$ is
\begin{equation}
  \label{eqn:dN_flatspace}
  \diff N = \frac{1}{h^3} f \,\diff^3 x\, \diff^3p.
\end{equation}
Because $h$ has units length$\times$momentum, we can see that $f$ is
dimensionless.

How much energy is in the radiation occupying a particular phase space volume?
The energy carried by $\diff N$ particles centered on $\{x^j,p_k\}$
is $\varepsilon\,\diff N$,
where $\varepsilon=pc$ and $p\equiv (p_ip^i)^{-1/2}$.
In spherical polar coordinates we may write
$\diff^3p=p^2\,\diff p\,\diff\Omega=\frac{\varepsilon^2}{c^3}\,\diff\varepsilon\,\diff\Omega$.
And we may identify $\diff^3x$
with the spatial volume occupied by a beam of particles
moving in direction $\Omega_k$,
passing through a surface $\diff a$
oriented by $a^i$,
over a time $\diff t$ centered on $t$,
so that $\diff^3x=c\,\diff t\,\mu\,\diff a$.
So in the particle picture, we have
\begin{equation}
  \label{eqn:beam_energy_f}
  \diff E = \frac{\varepsilon^3}{h^3c^2} f(t,x^j;p_k)\,
  \diff t\,\mu\,\diff a\, \diff\varepsilon\,\diff\Omega.
\end{equation}
Comparing Eqn.~\ref{eqn:beam_energy_I_eps} to Eqn.~\ref{eqn:beam_energy_f},
it's clear that
\begin{equation}
  \mathcal{I}=\frac{\varepsilon^3}{(hc)^2}f. \nonumber
\end{equation}
Below, we stick to the particle picture, formulating everything in terms of $f$.

\subsubsection{How $f$ Changes}
According to Liouville's Theorem,
absent any particle interactions with each other or with the medium, the density
of particles in phase space is constant along streamlines, $\Omega_k$. This may be
expressed as a continuity equation for the distribution function,
the advection equation:
\begin{align}
  \frac{1}{c}\partial_t f + \Omega^k\nabla_k f &= 0 \\
  \label{eqn:f_advection}
  p^\alpha\nabla_\alpha f &= 0,
\end{align}
where we have used the four-momentum in the second form.
In flat space, we may write it $p^\alpha:=(\varepsilon/c,p^k)$.

When particles interact with the medium, we can describe the changes to $f$ with
source and sink terms.
Let $k(\varepsilon,f)$ be the opacity, or cross section per unit mass of the
medium, so that $k\rho f$ is the number of particles of energy
$\varepsilon$ absorbed or scattered per length traversed by the ray.
And let $\eta(\varepsilon,f)$ be the emissivity, so that
$\eta/\varepsilon$ is the number of particles emitted per
unit volume at energy $\varepsilon$.
Opacity and emissivity are functions of $\varepsilon$ for obvious reasons, and
functions of $f$ because the processes of emission and absorption that these
objects describe may be stimulated by the radiation field.
Our equation of continuity, Eqn.~\ref{eqn:f_advection},
with source and sink terms is now
\begin{equation}
  \label{eqn:f_boltzmann}
  p^\alpha\nabla_\alpha f = \frac{1}{c}
  \left( \left(\frac{hc}{\varepsilon}\right)^2\eta - \varepsilon k \rho f\right).
\end{equation}
In cgs, $k$ is measured in cm$^2$~g$^{-1}$ and $\eta$ is measured in
erg~cm$^{-3}$. This is the Boltzmann equation of transport.

We may think of $k$ in terms of the cross-sections of absorption and scattering
processes; then we could write $\rho k = n(\sigma_{\rm abs}+\sigma_{\rm scatt})$,
where $n$ is the number density of the particles in the medium participating in
this process.
Also, note that we may analyze $k$ and $\eta$ by individual processes causing the
absorption, scattering, or emission; then these terms are sums.

We may find solutions by integrating this equation along rays using the length
parameterization $\diff s=c\,\diff t$, so that
$\Omega^i\nabla_i f=\diff f/\diff s$, with the rays defined by
the geodesic equations in Euclidean space:
\begin{equation}
  \label{eqn:geo_straight_ray}
  \frac{\diff x^j}{\diff s}=p^j, \qquad {\rm and} \qquad
  \frac{\diff p_k}{\diff s}=0.
\end{equation}
With this parameterization, Eqn.~\ref{eqn:f_boltzmann} becomes
\begin{equation}
  \label{eqn:f_boltzmann_ray}
  \frac{1}{c} \partial_t f + \frac{\diff}{\diff s} f =
  \frac{(hc)^2}{\varepsilon^3}\eta - \rho k f,
\end{equation}

\subsubsection{Optical Depth}
A ray of radiation passing through a medium will attenuate due to scattering and
absorption. If there is no emission, and $f$ is changing quickly with respect to
fluid changes ($\lambda/c \ll T_{\rm dyn}$, in our context, where
$\lambda=(\rho k)^{-1}$ is the mean free path, and $T_{\rm dyn}$ is the timescale
of fluid changes presented in Sec.~\ref{sec:timescales})
Eqn.~\ref{eqn:f_boltzmann_ray} simplifies to
\begin{equation}
  \left(\frac{\diff}{\diff s} - \chi\right)f=0.
\end{equation}
where we have used $\chi\equiv\rho k$.
This is a linear first-order differential equation, which we may solve by
assuming an integrating factor $u(s)$ such that $u\chi=\diff u/\diff s$.
We find that $u(s)=\exp\left(-\tau(A,B)\right)$, where
\begin{equation}
  \label{eqn:tau_flatspace}
  \Omega^j\nabla_j \tau = \chi, \qquad {\rm or} \qquad
  \tau \equiv \int_A^B \diff s\, \chi.
\end{equation}
While traveling from A to B, the number of particles in the beam attenuates by
the factor $\exp(-\tau)$.

\subsection{Curved Spacetime}
The preceding formalism may be extended to curved spacetimes by a suitable
covariant reformulation. Following \citet{lind1966-gr_boltzmann}\footnote{with
two slight modifications in that 1) we use the covariant four-momentum $p_\alpha$
to construct a more natural phase space volume element $\diff V\,\diff P$ below,
and 2) we include the projection of the momentum onto the observer's worldline,
$-p_\mu U^\mu$, in Eqn.~\ref{eqn:covariant_dV} where it seems to fit more
naturally},
and also drawing on \citet{ipse1968-gr_boltzmann},
we extend our manifold to four-dimensional spacetime
$M^4:\{x^\alpha\}$. The cotangent bundle, or phase space, is now
$T^*M:\{x^\alpha,p_\beta\}$.
We imagine an observer in this spacetime with four-velocity $U^\lambda$.

Our observer measures a spatial
volume $\diff V$ spanned by the three spacelike vectors
$\diff_1x^\alpha$, $\diff_2x^\beta$, $\diff_3x^\gamma$
(not differentials, but with names that look suggestively like differentials)
at $x^\mu$:
\begin{align}
  \label{eqn:covariant_dV}
  -U_\lambda\,\diff V &= \sqrt{-\psi} \, \epsilon_{\alpha\beta\gamma\lambda}\,
  \diff_1x^\alpha\, \diff_2x^\beta\, \diff_3x^\gamma (-p_\mu U^\mu) \\
  \label{eqn:dV}
  \diff V       &= \sqrt{-\psi} \, U^t \diff x\,\diff y\,\diff z\, (-p_\mu U^\mu),
\end{align}
where in the first equation, $\epsilon_{\alpha\beta\gamma\lambda}$ is the
totally antisymmetric tensor, and in the second equation we have
chosen to use the three cartesian basis vectors to span the volume.
$U^t \,\diff x\,\diff y\,\diff z$ is a scalar,
as are $\sqrt{-\psi}$ and the scalar product, which confirms that we have
constructed a Lorentz invariant spatial volume.

Our observer
measures a momentum volume $\diff P$ spanned by three timelike 1-forms
$\diff_1p_\alpha$, $\diff_2p_\beta$, $\diff_3p_\gamma$ at $p_\mu$
\begin{align}
  \label{eqn:covariant_dP}
  p^\lambda\, \diff P &= \frac{1}{\sqrt{-\psi}} \, \epsilon^{\alpha\beta\gamma\lambda}\,
  \diff_1p_\alpha\, \diff_2p_\beta\, \diff_3p_\gamma \\
  \label{eqn:dP}
  \diff P &= \frac{1}{\sqrt{-\psi}} \, \frac{1}{p^t} \diff p_x\, \diff p_y\, \diff p_z,
\end{align}
where again, in the second equation we have chosen to use the cartesian momentum
basis 1-forms.
Again $\diff p_x\, \diff p_y\, \diff p_z/p^t$ is a scalar,
which confirms that we have
constructed a Lorentz invariant momentum volume.

Then the invariant distribution function is the number of particle worldlines
passing through the invariant six-volume $\diff V\,\diff P$, scaled to a quantum
state by $h^3$:
\begin{align}
  \label{eqn:dN_covariant}
  \diff N &= \frac{1}{h^3} f\, \diff V \, \diff P\\
  \label{eqn:dN}
  &= \frac{1}{h^3} f\,
  \diff x\,\diff y\,\diff z\, \diff p_x\, \diff p_y\, \diff p_z\,
  \frac{U^t}{p^t} (-p_\mu U^\mu),
\end{align}
which is the covariant form of Eqn.~\ref{eqn:dN_flatspace}. The correspondence
may be seen by evaluating Eqn.~\ref{eqn:dN} in the locally flat Lorentz frame of
the observer, for whom $U^\alpha:=(1,0,0,0)$, and
$p_\mu U^\mu=p_tU^t=p_t=-p^t$.

\subsubsection{How $f$ Changes}
The covariant Boltzmann transport equation still takes the form of
Eqn.~\ref{eqn:f_boltzmann}, but $\nabla_\alpha$ now indicates covariant
differentiation (which, in the case of a scalar $f$, is simply
$\partial_\alpha$). But we may write the source and sink terms as
manifestly covariant objects:
\begin{equation}
  \label{eqn:f_boltzmann_covariant}
  p^\alpha \nabla_\alpha f = c \mathcal{E} - \frac{h}{c} \mathcal{A} f
\end{equation}
where the invariant spontaneous emission rate per rest mass of the medium is
$\mathcal{E}\equiv h^2\eta/\varepsilon^2$, measured in erg~s$^2$~cm$^{-3}$,
and the invariant opacity is
$\mathcal{A}\equiv \varepsilon k \rho/h$, measured in cm$^{-1}$~s$^{-1}$.

We may integrate this equation along rays using the length parameterization
$\diff\lambda=c\,\diff t/p^t$ with the rays defined by the geodesic equations in
curved spacetime:
\begin{equation}
  \label{eqn:geo_curved_ray}
  \frac{\diff x^\alpha}{\diff \lambda}=p^\alpha, \qquad {\rm and} \qquad
  \frac{\diff p_\beta}{\diff \lambda} =-\psi_{\alpha\beta}\Gamma^\alpha_{\mu\gamma} p^\mu p^\gamma,
\end{equation}
where $\Gamma^\alpha_{\mu\gamma}$ are the standard connection coefficients,
defined in Eqn.~\ref{eqn:christoffel}.

\subsubsection{Optical Depth}
The optical depth equation, Eqn.~\ref{eqn:tau_flatspace}, becomes
\begin{equation}
  \label{eqn:tau_covariant}
  p^\alpha\nabla_\alpha \tau = \frac{h}{c} \mathcal{A}, \qquad {\rm or} \qquad
  \tau \equiv \frac{h}{c} \int_A^B \diff \lambda\, \mathcal{A}.
\end{equation}
